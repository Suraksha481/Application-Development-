@using JournalProject.Services

@if (IsVisible)
{
    <!-- Centered Modal Overlay -->
    <div class="modal-overlay" @onclick="() => Cancel()">
        <div class="modal-popup" @onclick:stopPropagation="true">
            <!-- Header -->
            <div class="modal-header-custom">
                <h4 class="mb-0">üîí Enter Password</h4>
                <button type="button" class="btn-close" @onclick="() => Cancel()"></button>
            </div>

            <!-- Content -->
            <div class="modal-body-custom">
                <p>This journal is locked. Please enter your password to view it.</p>

                @if (!string.IsNullOrEmpty(PasswordType))
                {
                    <div class="alert alert-info mb-3">
                        <strong>Password Type:</strong> @PasswordType
                    </div>
                }

                <form @onsubmit="HandleSubmit">
                    <div class="mb-3">
                        <label class="form-label">Password *</label>
                        <input type="@(ShowPassword ? "text" : "password")" 
                               class="form-control" 
                               @bind="Password" 
                               placeholder="Enter your password"
                               required 
                               autofocus />
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="showPwd" @bind="ShowPassword" />
                        <label class="form-check-label" for="showPwd">
                            Show password
                        </label>
                    </div>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger mb-3">
                            <strong>Error:</strong> @ErrorMessage
                        </div>
                    }

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" disabled="@IsLoading">
                            @if (IsLoading)
                            {
                                <span>‚è≥ Verifying...</span>
                            }
                            else
                            {
                                <span>üîì View Journal</span>
                            }
                        </button>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="modal-footer-custom">
                <button type="button" class="btn btn-secondary" @onclick="() => Cancel()" disabled="@IsLoading">
                    Cancel
                </button>
            </div>
        </div>
    </div>
}

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1100;
    }

    .modal-popup {
        background-color: var(--bg-secondary);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 400px;
        display: flex;
        flex-direction: column;
        color: var(--text-primary);
    }

    .modal-header-custom {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header-custom h4 {
        margin: 0;
        font-weight: 600;
        color: var(--text-primary);
    }

    .modal-body-custom {
        padding: 20px;
        flex: 1;
        color: var(--text-primary);
    }

    .modal-footer-custom {
        padding: 15px 20px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
</style>

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public string? PasswordType { get; set; }

    [Parameter]
    public EventCallback<string> OnPasswordConfirmed { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private string Password = "";
    private bool ShowPassword = false;
    private string ErrorMessage = "";
    private bool IsLoading = false;

    private async Task HandleSubmit()
    {
        if (string.IsNullOrEmpty(Password))
        {
            ErrorMessage = "Please enter your password";
            return;
        }

        IsLoading = true;
        ErrorMessage = "";

        await Task.Delay(300);
        await OnPasswordConfirmed.InvokeAsync(Password);
        
        IsLoading = false;
    }

    private async Task Cancel()
    {
        Password = "";
        ShowPassword = false;
        ErrorMessage = "";
        await OnCancel.InvokeAsync();
    }

    public void SetError(string message)
    {
        ErrorMessage = message;
    }

    public void Reset()
    {
        Password = "";
        ShowPassword = false;
        ErrorMessage = "";
        IsLoading = false;
    }
}
