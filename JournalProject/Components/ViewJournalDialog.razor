@page "/view-journal/{EntryId:int}"
@using JournalProject.Services
@using JournalProject.Models
@inject NavigationManager NavigationManager
@inject JournalService JournalService
@inject IJSRuntime JS

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            @if (IsVisible)
            {
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>üìñ View Journal Entry</h2>
                    <button type="button" class="btn btn-outline-secondary" @onclick="() => Close()">
                        ‚Üê Back
                    </button>
                </div>

                <div class="card shadow">
                    <div class="card-body">
                        @if (JournalEntry != null)
                        {
                            <!-- Title -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Title</label>
                                <div class="form-control-plaintext fs-4">
                                    @JournalEntry.Title
                                </div>
                                <small class="text-muted">
                                    @JournalEntry.EntryDate.ToString("dddd, MMMM dd, yyyy")
                                </small>
                            </div>

                            <!-- Content -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Content</label>
                                <div class="form-control view-content-box" style="min-height: 250px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">
                                    @JournalEntry.Content
                                </div>
                            </div>

                            <!-- Primary Mood and Word Count -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Primary Mood</label>
                                    <div class="form-control-plaintext">
                                        @if (!string.IsNullOrEmpty(JournalEntry.PrimaryMood))
                                        {
                                            <span class="badge bg-primary" style="font-size: 13px; padding: 8px 12px;">@JournalEntry.PrimaryMood</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not specified</span>
                                        }
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Word Count</label>
                                    <div class="form-control-plaintext">
                                        <strong>@JournalEntry.WordCount words</strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Secondary Moods -->
                            @if (!string.IsNullOrEmpty(JournalEntry.SecondaryMood1) || !string.IsNullOrEmpty(JournalEntry.SecondaryMood2))
                            {
                                <div class="row mb-4">
                                    @if (!string.IsNullOrEmpty(JournalEntry.SecondaryMood1))
                                    {
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Secondary Mood 1</label>
                                            <div class="form-control-plaintext">
                                                <span class="badge bg-secondary" style="font-size: 13px; padding: 8px 12px;">@JournalEntry.SecondaryMood1</span>
                                            </div>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(JournalEntry.SecondaryMood2))
                                    {
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Secondary Mood 2</label>
                                            <div class="form-control-plaintext">
                                                <span class="badge bg-secondary" style="font-size: 13px; padding: 8px 12px;">@JournalEntry.SecondaryMood2</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Category -->
                            @if (!string.IsNullOrEmpty(JournalEntry.Category))
                            {
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Category</label>
                                    <div class="form-control-plaintext">
                                        @JournalEntry.Category
                                    </div>
                                </div>
                            }

                            <!-- Tags -->
                            @if (JournalEntry.Tags.Count > 0)
                            {
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Tags</label>
                                    <div class="form-control-plaintext">
                                        @foreach (var tag in JournalEntry.Tags)
                                        {
                                            <span class="badge bg-warning text-dark me-2 mb-2" style="font-size: 13px; padding: 8px 12px;">@tag</span>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Timestamps -->
                            <hr />
                            <div class="text-muted small">
                                <small>Created: @JournalEntry.CreatedAt.ToString("g")</small><br />
                                <small>Updated: @JournalEntry.UpdatedAt.ToString("g")</small>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mb-0">Journal entry not found</div>
                        }
                    </div>

                    <!-- Footer -->
                    <div class="card-footer bg-light d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" @onclick="() => Close()">
                            ‚Üê Back
                        </button>
                        <div class="gap-2">
                            <button type="button" class="btn btn-primary" @onclick="() => EditEntry()" disabled="@(JournalEntry?.IsLocked == true)">
                                ‚úèÔ∏è Edit
                            </button>
                            <button type="button" class="btn btn-danger" @onclick="() => DeleteEntry()">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info">Loading journal entry...</div>
            }
        </div>
    </div>
</div>

<style>
    .view-content-box {
        display: block;
        border: 1px solid #dee2e6;
    }

    .form-control-plaintext {
        display: block;
        padding: 0.375rem 0;
        border: none;
    }
</style>

@code {
    [Parameter]
    public int EntryId { get; set; }

    private bool IsVisible = false;
    private JournalProject.Models.JournalEntry? JournalEntry;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntry();
    }

    private async Task LoadEntry()
    {
        try
        {
            var entries = await JournalService.GetAllAsync();
            JournalEntry = entries.FirstOrDefault(e => e.Id == EntryId);
            IsVisible = JournalEntry != null;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading entry: {ex.Message}");
        }
    }

    private async Task Close()
    {
        NavigationManager.NavigateTo("/journal");
    }

    private void EditEntry()
    {
        if (JournalEntry != null)
        {
            NavigationManager.NavigateTo($"/add-journal/{JournalEntry.Id}");
        }
    }

    private async Task DeleteEntry()
    {
        if (JournalEntry != null)
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this journal entry? This action cannot be undone.");
            
            if (confirmed)
            {
                try
                {
                    await JournalService.DeleteAsync(JournalEntry.EntryDate);
                    await JS.InvokeVoidAsync("alert", "Journal entry deleted successfully!");
                    NavigationManager.NavigateTo("/journal");
                }
                catch (Exception ex)
                {
                    await JS.InvokeVoidAsync("alert", $"Error deleting entry: {ex.Message}");
                }
            }
        }
    }
}
