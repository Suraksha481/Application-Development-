@using JournalProject.Services

<div class="modal fade" id="passwordModal" tabindex="-1" role="dialog" aria-hidden="true" @ref="modalElement">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@Title</h5>
                <button type="button" class="btn-close" @onclick="OnCancel"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="passwordInput" class="form-label">@(IsPin ? "Enter PIN (4-6 digits)" : "Enter Password")</label>
                    <input type="@(ShowPassword ? "text" : "password")" 
                           class="form-control @(HasError ? "is-invalid" : "")"
                           id="passwordInput"
                           @bind="PasswordInput"
                           placeholder="@(IsPin ? "1234" : "Enter password")"
                           @onkeypress="HandleKeyPress">
                    @if (IsPin)
                    {
                        <div class="form-text">Must be 4-6 digits</div>
                    }
                    else
                    {
                        <div class="form-text">At least 8 characters with uppercase, lowercase, numbers, and special character</div>
                    }
                </div>

                @if (ShowConfirmPassword)
                {
                    <div class="mb-3">
                        <label for="confirmPasswordInput" class="form-label">Confirm Password</label>
                        <input type="@(ShowPassword ? "text" : "password")" 
                               class="form-control @(HasError ? "is-invalid" : "")"
                               id="confirmPasswordInput"
                               @bind="ConfirmPasswordInput"
                               placeholder="Confirm password"
                               @onkeypress="HandleKeyPress">
                    </div>
                }

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="showPassword" @bind="ShowPassword">
                    <label class="form-check-label" for="showPassword">Show Password</label>
                </div>

                @if (HasError)
                {
                    <div class="alert alert-danger" role="alert">
                        @ErrorMessage
                    </div>
                }

                @if (ValidationMessages.Count > 0 && ShowConfirmPassword)
                {
                    <div class="alert alert-warning" role="alert">
                        <ul class="mb-0">
                            @foreach (var msg in ValidationMessages)
                            {
                                <li>@msg</li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="OnCancel">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="OnConfirm">
                    @(ShowConfirmPassword ? "Set Password" : "Unlock")
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<string> OnPasswordSubmitted { get; set; }

    [Parameter]
    public EventCallback OnCancelled { get; set; }

    [Parameter]
    public string Title { get; set; } = "Enter Password";

    [Parameter]
    public bool IsPin { get; set; } = false;

    [Parameter]
    public bool ShowConfirmPassword { get; set; } = false;

    [Inject]
    [Parameter]
    public SecurityService? SecurityService { get; set; }

    private string PasswordInput = "";
    private string ConfirmPasswordInput = "";
    private bool ShowPassword = false;
    private bool HasError = false;
    private string ErrorMessage = "";
    private List<string> ValidationMessages = new();
    private ElementReference modalElement;

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await OnConfirm();
        }
    }

    private async Task OnConfirm()
    {
        HasError = false;
        ErrorMessage = "";
        ValidationMessages.Clear();

        if (SecurityService == null)
        {
            HasError = true;
            ErrorMessage = "Security service not initialized";
            return;
        }

        if (string.IsNullOrEmpty(PasswordInput))
        {
            HasError = true;
            ErrorMessage = IsPin ? "PIN cannot be empty" : "Password cannot be empty";
            return;
        }

        if (IsPin)
        {
            if (!await SecurityService.ValidatePIN(PasswordInput))
            {
                HasError = true;
                ErrorMessage = "PIN must be 4-6 digits";
                return;
            }
        }
        else if (ShowConfirmPassword)
        {
            if (PasswordInput != ConfirmPasswordInput)
            {
                HasError = true;
                ErrorMessage = "Passwords do not match";
                return;
            }

            var (isValid, issues) = SecurityService.ValidatePasswordStrength(PasswordInput);
            if (!isValid)
            {
                ValidationMessages = issues;
                HasError = true;
                ErrorMessage = "Password does not meet requirements";
                return;
            }
        }

        await OnPasswordSubmitted.InvokeAsync(PasswordInput);
        ClearForm();
    }

    private async Task OnCancel()
    {
        ClearForm();
        await OnCancelled.InvokeAsync();
    }

    private void ClearForm()
    {
        PasswordInput = "";
        ConfirmPasswordInput = "";
        ShowPassword = false;
        HasError = false;
        ErrorMessage = "";
        ValidationMessages.Clear();
    }
}
